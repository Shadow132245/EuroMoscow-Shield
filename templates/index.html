<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EuroMoscow | V25</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/lua/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>

    <style>
        /* V25 DESIGN SYSTEM */
        :root {
            --bg: #09090b; --panel: #18181b; --border: #27272a; 
            --primary: #3b82f6; --text: #e4e4e7;
        }
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }

        /* Navbar */
        nav { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid var(--border); background: rgba(9,9,11,0.95); backdrop-filter: blur(10px); z-index: 100; }
        .brand { font-size: 20px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px; } .brand i { color: var(--primary); }
        .tabs { display: flex; gap: 5px; background: #27272a; padding: 4px; border-radius: 8px; }
        .tab { padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #a1a1aa; transition: 0.2s; }
        .tab:hover { color: #fff; } .tab.active { background: var(--primary); color: #fff; }
        .nav-links { display: flex; gap: 15px; }
        .link { color: #a1a1aa; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; } .link:hover { color: #fff; }

        /* Sidebar */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 340px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 10; }
        
        .mode-box { display: flex; background: #000; border-radius: 6px; padding: 4px; border: 1px solid var(--border); margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 4px; font-weight: 700; font-size: 12px; color: #71717a; transition: 0.2s; }
        .mode-btn.active { background: #27272a; color: #fff; }

        .opt-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #27272a; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .opt-item:hover { border-color: var(--primary); } input[type=checkbox] { accent-color: var(--primary); transform: scale(1.2); }
        .opt-lbl { font-weight: 600; font-size: 13px; }

        .btn-act { width: 100%; padding: 14px; border-radius: 6px; border: none; background: var(--primary); color: #fff; font-weight: 700; font-size: 14px; cursor: pointer; margin-top: auto; }
        .btn-scan { width: 100%; background: rgba(59,130,246,0.1); color: var(--primary); padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; text-align: center; border: 1px solid var(--primary); margin-bottom: 15px; }

        /* Editor */
        .editor-area { flex: 1; display: flex; flex-direction: column; }
        .editor-header { height: 45px; background: #111; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 12px; font-weight: 700; color: #71717a; }
        .CodeMirror { flex: 1; font-family: 'JetBrains Mono'; font-size: 14px; background: transparent !important; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .win { width: 70%; height: 70%; background: #18181b; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .win-head { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); background: #111; }
        .win-body { flex: 1; padding: 20px; overflow-y: auto; color: #ccc; }
        
        /* Terminal */
        .term-body { background: #0a0a0a; color: #00ff88; font-family: 'VT323', monospace; font-size: 20px; padding: 20px; flex: 1; overflow-y: auto; }
        .term-in { display: flex; padding: 10px; border-top: 1px solid #333; background: #0a0a0a; font-family: 'VT323'; font-size: 20px; }
        .term-input { flex: 1; background: transparent; border: none; color: #fff; font-family: inherit; font-size: inherit; outline: none; }

        /* Docs */
        .docs-body pre { background: #000; padding: 15px; border-radius: 6px; border: 1px solid #333; color: #a5b3ce; overflow-x: auto; font-family: 'JetBrains Mono'; font-size: 13px; }

        /* AI Chat */
        .ai-widget { position: fixed; bottom: 30px; right: 30px; z-index: 200; }
        .ai-btn { width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; cursor: pointer; box-shadow: 0 10px 30px rgba(59,130,246,0.3); transition:0.3s; }
        .ai-btn:hover { transform: scale(1.1); }
        .ai-box { position: absolute; bottom: 80px; right: 0; width: 350px; height: 500px; background: #18181b; border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .ai-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 13px; }
        .msg { padding: 10px 14px; border-radius: 10px; max-width: 85%; line-height: 1.4; }
        .msg.bot { background: #27272a; color: #e4e4e7; align-self: flex-start; }
        .msg.user { background: var(--primary); color: #fff; align-self: flex-end; }
        .ai-input-box { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #111; }
        .ai-input { flex: 1; background: #27272a; border: none; color: #fff; padding: 10px; border-radius: 6px; outline: none; }

        .loader-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 50; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 900px) { .layout { flex-direction: column; } .sidebar { width: 100%; order: 2; } .editor-area { height: 450px; order: 1; } .tabs { display: none; } }
    </style>
</head>
<body>

    <nav>
        <div class="brand"><i class="fas fa-shield-halved"></i> EuroMoscow <small style="margin-left:5px; opacity:0.5;">V25</small></div>
        <div class="tabs">
            <div class="tab active" onclick="setLang('python', '#3b82f6')">Python</div>
            <div class="tab" onclick="setLang('javascript', '#facc15')">JavaScript</div>
            <div class="tab" onclick="setLang('lua', '#22c55e')">Lua</div>
            <div class="tab" onclick="setLang('php', '#8b5cf6')">PHP</div>
            <div class="tab" onclick="setLang('html', '#f97316')">HTML</div>
        </div>
        <div class="nav-links">
            <div class="link" onclick="toggleOverlay('term')"><i class="fas fa-terminal"></i> Terminal</div>
            <div class="link" onclick="toggleOverlay('docs')"><i class="fas fa-book"></i> API</div>
        </div>
    </nav>

    <div class="layout">
        <div class="sidebar">
            <div class="mode-box">
                <div class="mode-btn active enc" onclick="setMode('encrypt')">Encrypt</div>
                <div class="mode-btn" onclick="setMode('decrypt')">Decrypt</div>
            </div>

            <div id="encPanel" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                <div class="btn-scan" onclick="analyze()"><i class="fas fa-magic"></i> AI Security Scan</div>
                <div id="optionsList"></div>
                
                <div style="margin-top: 20px; font-size: 11px; font-weight: 700; color: #52525b;">FILES</div>
                <button class="opt-item" onclick="document.getElementById('file').click()" style="justify-content: center; color: #aaa;">
                    <i class="fas fa-upload" style="margin-right: 8px;"></i> Upload File
                </button>
                <input type="file" id="file" style="display: none;">
            </div>

            <div id="decPanel" style="display: none; text-align: center; margin-top: 40px; color: #71717a;">
                <i class="fas fa-robot" style="font-size: 40px; margin-bottom: 15px; color: var(--primary);"></i>
                <p style="font-size: 13px;">EuroMind AI will auto-detect encryption.</p>
            </div>

            <button class="btn-act" onclick="process()">PROTECT CODE</button>
            <button class="btn-act" style="background: transparent; border: 1px solid var(--border); margin-top: 10px; color: var(--text-dim);" onclick="download()">Download File</button>
        </div>

        <div class="editor-area" style="flex: 1; display: flex;">
            <div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border);">
                <div class="editor-header"><span>INPUT</span> <i class="fas fa-eraser" onclick="editor.setValue('')" style="cursor: pointer;"></i></div>
                <textarea id="editor"></textarea>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="editor-header"><span>OUTPUT</span> <i class="fas fa-copy" onclick="copy()" style="cursor: pointer;"></i></div>
                <textarea id="out"></textarea>
            </div>
        </div>
    </div>

    <div id="termOverlay" class="overlay">
        <div class="win">
            <div class="win-head" style="border-color: #0f0; color: #0f0;"><span>TERMINAL</span> <i class="fas fa-times close-btn" onclick="toggleOverlay('term')"></i></div>
            <div class="term-body" id="termOut">EuroShield Terminal v25... Ready.<br>Type python code to execute.</div>
            <div class="term-in">
                <span style="color: #0f0; margin-right: 10px;">$</span>
                <input type="text" id="termInput" class="term-input" autofocus>
            </div>
        </div>
    </div>

    <div id="docsOverlay" class="overlay">
        <div class="win docs-window">
            <div class="win-head"><span>API DOCS</span> <i class="fas fa-times close-btn" onclick="toggleOverlay('docs')"></i></div>
            <div class="win-body docs-body">
                <h2>POST /process</h2>
                <p>Endpoint to encrypt or decrypt code.</p>
                <div style="background: #111; padding: 10px; border: 1px solid #333; margin: 15px 0; color: var(--primary);">
                    URL: {{ request.url_root }}process
                </div>
                <pre>
import requests
res = requests.post("{{ request.url_root }}process", json={
    "code": "print('Hello')",
    "action": "encrypt",
    "lang": "python",
    "options": ["rename"]
})
print(res.json()['result'])</pre>
            </div>
        </div>
    </div>

    <div class="ai-widget">
        <div class="ai-box" id="aiBox">
            <div class="ai-head"><span>EuroMind AI</span> <i class="fas fa-times" style="cursor: pointer;" onclick="toggleAi()"></i></div>
            <div class="ai-msgs" id="aiContent"><div class="chat-msg chat-bot">Hello! I can analyze code and fix errors. Ask me!</div></div>
            <div class="ai-input-area">
                <input type="text" id="aiInput" class="ai-input-field" placeholder="Ask something...">
                <i class="fas fa-paper-plane" style="color: var(--primary); cursor: pointer;" onclick="sendAi()"></i>
            </div>
        </div>
        <div class="ai-btn" onclick="toggleAi()"><i class="fas fa-robot"></i></div>
    </div>

    <div class="loader-overlay" id="loader"><div class="spinner"></div></div>

    <script>
        let curLang = 'python';
        let curMode = 'encrypt';

        const config = {
            python: { color: '#3b82f6', mode: 'python', opts: [ {id: 'rename', l: 'Variable Renaming'}, {id: 'marshal', l: 'Portable Blob'}, {id: 'deadcode', l: 'Dead Code Injection'}, {id: 'xor', l: 'XOR Encryption'} ] },
            javascript: { color: '#facc15', mode: 'javascript', opts: [ {id: 'hex', l: 'Hex Encoding'}, {id: 'base64', l: 'Base64 Eval'}, {id: 'url', l: 'URL Encode'} ] },
            lua: { color: '#22c55e', mode: 'lua', opts: [ {id: 'byte', l: 'Bytecode Array'}, {id: 'hex', l: 'Hex Loader'} ] },
            php: { color: '#8b5cf6', mode: 'php', opts: [ {id: 'base64', l: 'Gzip + Base64'} ] },
            html: { color: '#f97316', mode: 'htmlmixed', opts: [ {id: 'hex', l: 'Hex Write'} ] }
        };

        var editor = CodeMirror.fromTextArea(document.getElementById("editor"), { mode: "python", theme: "dracula", lineNumbers: true });
        var out = CodeMirror.fromTextArea(document.getElementById("out"), { mode: "python", theme: "dracula", lineNumbers: true, readOnly: true });

        function setLang(l, c) {
            curLang = l;
            document.documentElement.style.setProperty('--primary', c);
            editor.setOption("mode", config[l].mode);
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const con = document.getElementById('optionsList'); con.innerHTML = '';
            config[l].opts.forEach(o => {
                con.innerHTML += `<label class="opt-item"><span class="opt-lbl">${o.l}</span><input type="checkbox" id="opt-${o.id}" checked></label>`;
            });
        }
        setLang('python', '#3b82f6'); // Init

        function setMode(m) {
            curMode = m;
            const btn = document.querySelector('.btn-act');
            if(m === 'encrypt') {
                document.getElementById('encPanel').style.display='flex';
                document.getElementById('decPanel').style.display='none';
                document.querySelector('.mode-btn.enc').classList.add('active', 'enc');
                document.querySelector('.mode-btn.dec').classList.remove('active', 'dec');
                btn.innerText = 'PROTECT CODE';
            } else {
                document.getElementById('encPanel').style.display='none';
                document.getElementById('decPanel').style.display='block';
                document.querySelector('.mode-btn.dec').classList.add('active', 'dec');
                document.querySelector('.mode-btn.enc').classList.remove('active', 'enc');
                btn.innerText = 'DECRYPT CODE';
            }
        }

        async function process() {
            const code = editor.getValue(); if(!code) return alert("No Code!");
            let opts = []; if(curMode==='encrypt') document.querySelectorAll('input:checked').forEach(c=>opts.push(c.id.replace('opt-','')));
            document.getElementById('loader').style.display='flex';
            try {
                const res = await fetch('/process', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({code, action: curMode, lang: curLang, options: opts}) });
                const d = await res.json(); out.setValue(d.result);
            } catch { alert("Error"); } finally { document.getElementById('loader').style.display='none'; }
        }

        function download() {
            const blob = new Blob([out.getValue()], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Protected.${curLang==='python'?'py':'js'}`; a.click();
        }

        // Overlays
        function toggleOverlay(id) { 
            const el = document.getElementById(id+'Overlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            if(id === 'term' && el.style.display === 'flex') document.getElementById('termInput').focus();
        }

        // Terminal
        const termOut = document.getElementById('termOut');
        document.getElementById('termInput').addEventListener('keypress', async e => {
            if(e.key==='Enter') {
                const cmd = e.target.value; e.target.value = '';
                termOut.innerHTML += `<br><span style="color:#fff">$ ${cmd}</span>`;
                if(cmd==='clear') termOut.innerHTML = '';
                else {
                    const res = await fetch('/run', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({code: cmd, lang: curLang}) });
                    const d = await res.json();
                    termOut.innerHTML += `<br><span style="color:#0f0">${d.output}</span>`;
                }
                termOut.scrollTop = termOut.scrollHeight;
            }
        });

        // AI Chat
        function toggleAi() { const b=document.getElementById('aiBox'); b.style.display = b.style.display==='flex'?'none':'flex'; }
        async function sendAi() {
            const i=document.getElementById('aiInput'); const t=i.value; if(!t) return;
            const c=document.getElementById('aiContent');
            c.innerHTML += `<div class="chat-msg chat-user">${t}</div>`; i.value = '';
            const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: t, code: editor.getValue()}) });
            const d = await res.json();
            c.innerHTML += `<div class="chat-msg chat-bot">${d.reply}</div>`; c.scrollTop = c.scrollHeight;
        }
        document.getElementById('aiInput').addEventListener('keypress', e=>{if(e.key==='Enter')sendAi()});

        async function analyze() {
            const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: 'analyze this code', code: editor.getValue()}) });
            const d = await res.json();
            toggleAi();
            document.getElementById('aiContent').innerHTML += `<div class="chat-msg chat-bot">${d.reply}</div>`;
        }

        document.getElementById('file').addEventListener('change', e => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>editor.setValue(ev.target.result); r.readAsText(f); } });
        function copy() { navigator.clipboard.writeText(out.getValue()); alert("Copied!"); }
    </script>
</body>
</html>
